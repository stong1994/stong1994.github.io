




<!DOCTYPE html>
<html
  lang="en"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="light"
  data-auto-appearance="true"
><head>
  <meta charset="utf-8" />
  
    <meta http-equiv="content-language" content="en" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="rgb(255,255,255)" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>通讯录同步服务的演进 &middot; 主页</title>
    <meta name="title" content="通讯录同步服务的演进 &middot; 主页" />
  
  <meta name="description" content="" />
  
  
  
  <link rel="canonical" href="/internet/design/employee_adapter/" />
  
  
  
  
  
  
  
  
  
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="/css/main.bundle.min.d2d22c5c1c2460999b194d3fbbce6097c00f40fb952d56864bb609de68cbc5ea.css"
    integrity="sha256-0tIsXBwkYJmbGU0/u85gl8APQPuVLVaGS7YJ3mjLxeo="
  />
  
  
  <script type="text/javascript" src="/js/appearance.min.022d0ebc3b46a335eb1c7ef79b7f2de143d7cd5156d433638592ef1ce5f8554e.js" integrity="sha256-Ai0OvDtGozXrHH73m38t4UPXzVFW1DNjhZLvHOX4VU4="></script>
  
    
    
    
  
  
    
    
  
  
  
    
    <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.75206d23ef83f4908b2bdd2317bf6ddff399e9173a16fff5451c40b8e857cfa8.js" integrity="sha256-dSBtI&#43;&#43;D9JCLK90jF79t3/OZ6Rc6Fv/1RRxAuOhXz6g=" data-copy="Copy" data-copied="Copied"></script>
  
  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  <meta property="og:title" content="通讯录同步服务的演进" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/internet/design/employee_adapter/" /><meta property="article:section" content="internet" />
<meta property="article:published_time" content="2023-04-19T15:12:00+08:00" />
<meta property="article:modified_time" content="2023-04-19T15:12:00+08:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="通讯录同步服务的演进"/>
<meta name="twitter:description" content=""/>

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "",
    "name": "通讯录同步服务的演进",
    "headline": "通讯录同步服务的演进",
    
    
    "inLanguage": "en",
    "url" : "\/internet\/design\/employee_adapter\/",
    "author" : {
      "@type": "Person",
      "name": "stong"
    },
    "copyrightYear": "2023",
    "dateCreated": "2023-04-19T15:12:00\u002b08:00",
    "datePublished": "2023-04-19T15:12:00\u002b08:00",
    
    "dateModified": "2023-04-19T15:12:00\u002b08:00",
    
    
    
    "mainEntityOfPage": "true",
    "wordCount": "5717"
  }]
  </script>


  
  <meta name="author" content="stong" />
  
    
      <link href="st5983@outlook.com" rel="me" />
    
      <link href="https://stong1994.github.io/" rel="me" />
    
      <link href="https://github.com/stong1994" rel="me" />
    
  
  
  






  
  
  
  


  
  
</head>
<body
    class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"
  >
    <div id="the-top" class="absolute flex self-center">
      <a
        class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
        href="#main-content"
        ><span class="font-bold pe-2 text-primary-600 dark:text-primary-400">&darr;</span
        >Skip to main content</a
      >
    </div>
    
    
      <header class="py-6 font-semibold text-neutral-900 dark:text-neutral print:hidden sm:py-10">
  <nav class="flex items-start justify-between sm:items-center">
    
    <div class="z-40 flex flex-row items-center">
      
  <a
    class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
    rel="me"
    href="/"
    >主页</a
  >

      

    </div>
    
      
      <label id="menu-button" for="menu-controller" class="block sm:hidden">
        <input type="checkbox" id="menu-controller" class="hidden" />
        <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
          

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>

  </span>


        </div>
        <div
          id="menu-wrapper"
          class="invisible fixed inset-0 z-30 m-auto h-full w-full cursor-default overflow-auto bg-neutral-100/50 opacity-0 backdrop-blur-sm transition-opacity dark:bg-neutral-900/50"
        >
          <ul
            class="mx-auto flex w-full max-w-7xl list-none flex-col overflow-visible px-6 py-6 ltr:text-right rtl:text-left sm:px-14 sm:py-10 sm:pt-10 md:px-24 lg:px-32"
          >
            <li class="mb-1">
              <span class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"
                >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>

</span
              >
            </li>
            
              
                <li class="group mb-1">
                  
                    <a
                      href="/internet/"
                      title=""
                      
                      >
                        <span
                          class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                          >计算机与互联网</span
                        >
                      </a
                    >
                  
                </li>
              
                <li class="group mb-1">
                  
                    <a
                      href="/cloudnative/"
                      title=""
                      
                      >
                        <span
                          class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                          >云原生</span
                        >
                      </a
                    >
                  
                </li>
              
                <li class="group mb-1">
                  
                    <a
                      href="/web3/"
                      title="Web3s"
                      
                      >
                        <span
                          class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                          >区块链&amp;web3</span
                        >
                      </a
                    >
                  
                </li>
              
                <li class="group mb-1">
                  
                    <a
                      href="/book/"
                      title=""
                      
                      >
                        <span
                          class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                          >读书笔记</span
                        >
                      </a
                    >
                  
                </li>
              
                <li class="group mb-1">
                  
                    <a
                      href="/other/"
                      title=""
                      
                      >
                        <span
                          class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                          >杂谈</span
                        >
                      </a
                    >
                  
                </li>
              
                <li class="group mb-1">
                  
                    <a
                      href="/mental_model/"
                      title=""
                      
                      >
                        <span
                          class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                          >心智模型</span
                        >
                      </a
                    >
                  
                </li>
              
                <li class="group mb-1">
                  
                    <a
                      href="/about/"
                      title=""
                      
                      >
                        <span
                          class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                          >关于</span
                        >
                      </a
                    >
                  
                </li>
              
                <li class="group mb-1">
                  
                    <a
                      href="https://github.com/stong1994/"
                      title=""
                      target="_blank"
                      >
                        <span
                          class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"
                        >
                          

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>


                        </span>
                      </a
                    >
                  
                </li>
              
                <li class="group mb-1">
                  
                    
                    
                      <button
                        id="search-button-1"
                        title="Search (/)"
                      >
                        
                          <span
                            class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"
                          >
                            

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


                          </span>
                        
                          <span
                            class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                            ></span
                          >
                        
                      </button>
                    
                  
                </li>
              
              
            
          </ul>
        </div>
      </label>
      
      <ul class="hidden list-none flex-row ltr:text-right rtl:text-left sm:flex">
        
          
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="/internet/"
                  title=""
                  
                  >
                    <span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >计算机与互联网</span
                    >
                  </a
                >
              
            </li>
          
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="/cloudnative/"
                  title=""
                  
                  >
                    <span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >云原生</span
                    >
                  </a
                >
              
            </li>
          
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="/web3/"
                  title="Web3s"
                  
                  >
                    <span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >区块链&amp;web3</span
                    >
                  </a
                >
              
            </li>
          
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="/book/"
                  title=""
                  
                  >
                    <span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >读书笔记</span
                    >
                  </a
                >
              
            </li>
          
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="/other/"
                  title=""
                  
                  >
                    <span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >杂谈</span
                    >
                  </a
                >
              
            </li>
          
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="/mental_model/"
                  title=""
                  
                  >
                    <span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >心智模型</span
                    >
                  </a
                >
              
            </li>
          
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="/about/"
                  title=""
                  
                  >
                    <span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >关于</span
                    >
                  </a
                >
              
            </li>
          
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="https://github.com/stong1994/"
                  title=""
                  target="_blank"
                  >
                    <span
                      class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"
                    >
                      

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>


                    </span>
                  </a
                >
              
            </li>
          
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                
                
                  <button
                    id="search-button-2"
                    title="Search (/)"
                  >
                    
                      <span
                        class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"
                      >
                        

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


                      </span>
                    
                      <span
                        class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                        ></span
                      >
                    
                  </button>
                
              
            </li>
          
          

        
      </ul>
    
  </nav>
</header>

    
    <div class="relative flex flex-col grow">
      <main id="main-content" class="grow">
        
  <article>
    <header class="max-w-prose">
      
        <ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden">
  
  
    
  
    
  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/"
      >记录个人的成长记录</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline ">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/internet/"
      >internet</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/internet/design/employee_adapter/"
      >通讯录同步服务的演进</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

</ol>


      
      <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        通讯录同步服务的演进
      </h1>
      <div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
        





  
  



  

  
  
    
  

  

  
    
  

  
    
  

  
    
  


  <div class="flex flex-row flex-wrap items-center">
    
    
      <time datetime="2023-04-19 15:12:00 &#43;0800 CST">19 April 2023</time><span class="px-2 text-primary-500">&middot;</span><span>5717 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">12 mins</span><span class="px-2 text-primary-500">&middot;</span>


  
  

<span class="mb-[2px]">
  <a
    href="https://github.com/stong1994/cristo/content/internet/design/%e9%80%9a%e8%ae%af%e5%bd%95%e5%90%8c%e6%ad%a5%e6%9c%8d%e5%8a%a1%e7%9a%84%e6%bc%94%e8%bf%9b.md"
    class="text-lg hover:text-primary-500"
    rel="noopener noreferrer"
    target="_blank"
    title="Edit content"
    >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M490.3 40.4C512.2 62.27 512.2 97.73 490.3 119.6L460.3 149.7L362.3 51.72L392.4 21.66C414.3-.2135 449.7-.2135 471.6 21.66L490.3 40.4zM172.4 241.7L339.7 74.34L437.7 172.3L270.3 339.6C264.2 345.8 256.7 350.4 248.4 353.2L159.6 382.8C150.1 385.6 141.5 383.4 135 376.1C128.6 370.5 126.4 361 129.2 352.4L158.8 263.6C161.6 255.3 166.2 247.8 172.4 241.7V241.7zM192 63.1C209.7 63.1 224 78.33 224 95.1C224 113.7 209.7 127.1 192 127.1H96C78.33 127.1 64 142.3 64 159.1V416C64 433.7 78.33 448 96 448H352C369.7 448 384 433.7 384 416V319.1C384 302.3 398.3 287.1 416 287.1C433.7 287.1 448 302.3 448 319.1V416C448 469 405 512 352 512H96C42.98 512 0 469 0 416V159.1C0 106.1 42.98 63.1 96 63.1H192z"/></svg>

  </span>

</a
  >
</span>
    

    
    
  </div>

  
  
    <div class="my-1 text-xs leading-relaxed text-neutral-500 dark:text-neutral-400 ">
      
        
      
        
      
    </div>
  


      </div>
      
    </header>
    <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
      
        <div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8">
          <div class="toc pe-5 print:hidden lg:sticky lg:top-10">
            <details open class="-ms-5 mt-0 overflow-hidden rounded-lg ps-5">
  <summary
    class="-ms-5 block cursor-pointer bg-neutral-100 py-1 ps-5 text-lg font-semibold text-neutral-800 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden"
  >
    Table of Contents
  </summary>
  <div class="-ms-5 border-s border-dotted border-neutral-300 py-2 ps-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#背景">背景</a></li>
        <li><a href="#前言">前言</a>
          <ul>
            <li><a href="#同步流程">同步流程</a></li>
            <li><a href="#标识">标识</a></li>
            <li><a href="#简称">简称</a></li>
          </ul>
        </li>
        <li><a href="#第一版平平无奇的crud">第一版：平平无奇的CRUD</a>
          <ul>
            <li><a href="#全量同步">全量同步</a></li>
            <li><a href="#增量同步">增量同步</a>
              <ul>
                <li><a href="#部门的增量同步的基本流程">部门的增量同步的基本流程</a></li>
                <li><a href="#员工的增量同步的基本流程">员工的增量同步的基本流程</a></li>
              </ul>
            </li>
            <li><a href="#问题">问题</a></li>
          </ul>
        </li>
        <li><a href="#第二版统一员工和部门的实现">第二版：统一员工和部门的实现</a></li>
        <li><a href="#第三版抽象员工和部门的实现">第三版：抽象员工和部门的实现</a>
          <ul>
            <li><a href="#举例部门同步实现">举例：部门同步实现</a></li>
            <li><a href="#延伸模版方法模式">延伸：模版方法模式</a></li>
          </ul>
        </li>
        <li><a href="#其他问题">其他问题</a>
          <ul>
            <li><a href="#merkle-tree的应用">Merkle Tree的应用</a>
              <ul>
                <li><a href="#对部门构建哈希树">对部门构建哈希树</a></li>
                <li><a href="#对员工构建哈希树">对员工构建哈希树</a></li>
              </ul>
            </li>
            <li><a href="#分布式同步">分布式同步</a>
              <ul>
                <li><a href="#耗时分析">耗时分析</a></li>
                <li><a href="#节点划分">节点划分</a>
                  <ul>
                    <li><a href="#主节点竞选">主节点竞选</a></li>
                  </ul>
                </li>
                <li><a href="#任务拆分">任务拆分</a></li>
                <li><a href="#完成通知">完成通知</a></li>
              </ul>
            </li>
            <li><a href="#内存分析">内存分析</a></li>
            <li><a href="#不同场景的限流">不同场景的限流</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</details>

          </div>
        </div>
      
      <div class="min-w-0 min-h-0 max-w-prose grow">
        <h2 id="背景" class="relative group">背景 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e8%83%8c%e6%99%af" aria-label="Anchor">#</a></span></h2>
<p>一家企业往往会使用钉钉或者企业微信或者飞书进行日常的沟通交流，同时HR也要使用其他平台处理工作，比如招聘、考勤、审批等等，这时候将<strong>不同平台的通讯录进行同步</strong>就成为了一种“刚需”。</p>
<h2 id="前言" class="relative group">前言 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%89%8d%e8%a8%80" aria-label="Anchor">#</a></span></h2>
<p>在这篇博客里，我会专注于记录<strong>通讯录同步服务的技术架构上的演进</strong>，因此不会展示业务上的细节。</p>
<h3 id="同步流程" class="relative group">同步流程 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%90%8c%e6%ad%a5%e6%b5%81%e7%a8%8b" aria-label="Anchor">#</a></span></h3>
<p>同步逻辑大概是这样：</p>
<ol>
<li>对需要新增或者更新的部门进行新增或更新。</li>
<li>对需要新增或者更新的员工进行新增或更新。</li>
<li>对需要删除的员工进行删除。</li>
<li>同步部门leader。</li>
<li>对需要删除的部门进行删除。</li>
</ol>
<p>这个流程的其他部分的顺序是不能变的，这是因为：</p>
<ol>
<li>新增或者更新员工时，需要修改员工身上的部门信息，因此新增/更新部门要在新增/更新员工之前。</li>
<li>删除部门时要保证部门下的员工已删除，因此删除部门要在删除员工之后。</li>
<li>部门需要同步负责人信息，因此需要在同步完员工之后才能同步部门leader。</li>
</ol>
<h3 id="标识" class="relative group">标识 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e6%a0%87%e8%af%86" aria-label="Anchor">#</a></span></h3>
<p>第一次同步时只能通过名称或手机号进行关联，同步完后需要记录ID标识的映射关系，那么下次同步就可以直接使用ID进行同步。</p>
<p>对于部门来说，第一次同步会根据<strong>部门名称</strong>进行关联，以后再次同步就可以使用ID作为关联。</p>
<p>对于员工来说，第一次同步会使用<strong>员工手机号</strong>进行关联，以后再次同步就可以使用ID作为关联。</p>
<h3 id="简称" class="relative group">简称 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e7%ae%80%e7%a7%b0" aria-label="Anchor">#</a></span></h3>
<p>在这篇博客中，我会使用以下简称来描述某种信息：</p>
<ul>
<li>源数据：被同步的平台的通讯录数据。</li>
<li>目的数据：需要同步到的平台的通讯录数据。</li>
</ul>
<p>了解完以上信息之后我们就可以开始查看技术架构的演进了。</p>
<h2 id="第一版平平无奇的crud" class="relative group">第一版：平平无奇的CRUD <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e7%ac%ac%e4%b8%80%e7%89%88%e5%b9%b3%e5%b9%b3%e6%97%a0%e5%a5%87%e7%9a%84crud" aria-label="Anchor">#</a></span></h2>
<p>在第一版，我们主要需要做这些：</p>
<ol>
<li>对接两个平台的通讯录组件。</li>
<li>支持手动同步、定时同步和事件同步。</li>
</ol>
<p>因为只需要对接两个平台，因此就没有考虑通用性——<strong>避免过早优化</strong>，因为业务规则是需要逐步完善的，过早的考虑整体很容易造成过度设计，以至于浪费大量的精力。</p>
<h3 id="全量同步" class="relative group">全量同步 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%85%a8%e9%87%8f%e5%90%8c%e6%ad%a5" aria-label="Anchor">#</a></span></h3>
<p>手动同步和定时同步的逻辑是一样的，只是触发条件不同。基本流程是这样：</p>
<ol>
<li>准备数据，包括用户的配置数据、两个平台的部门和员工数据以及关联的ID。</li>
<li>对需要新增或者更新的部门进行新增或更新
<ol>
<li>按层级遍历源数据的部门树（bfs），令当前遍历的部门为A。</li>
<li>判断A部门是否已存在映射关系
<ol>
<li>若存在，令目的部门为a, 判断目的数据是否存在a
<ol>
<li>若存在，判断是否需要更新，若需要，则进行更新</li>
<li>若不存在，则需要新建部门，并更新ID映射</li>
</ol>
</li>
<li>若不存在，则获取对应服务门下的部门列表，查看是否有相同名称的部门
<ol>
<li>若存在，则判断是否需要更新，若需要，则进行更新，最后新建ID映射</li>
<li>若不存在，则需要新建部门，并新建ID映射</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>对需要新增或者更新的员工进行新增或更新。
<ol>
<li>遍历源数据的员工列表，令当前遍历的员工为E</li>
<li>判断员工E是否已存在映射关系
<ol>
<li>若存在，令目的员工为e，判断目的数据是否存在e
<ol>
<li>若存在，判断是否需要更新，若需要，则进行更新</li>
<li>若不存在，则需要新建员工，并更新ID映射</li>
</ol>
</li>
<li>若不存在，则根据手机号判断目的数据中是否存在该员工
<ol>
<li>若存在，则判断是否需要更新，若需要，则进行更新，最后新建ID映射</li>
<li>若不存在，则需要新建员工，并新建ID映射</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>对需要删除的员工进行删除：在上述步骤中，我们已经得知同步了哪些员工，将这些员工构成一个哈希表m，那么在目的数据中，不在哈希表m中的员工就是我们需要删除的员工。</li>
<li>同步部门leader：我们已经有了部门和员工的映射关系，因此直接同步部门leader即可。</li>
<li>对需要删除的部门进行删除：在上述步骤中，我们已经得知同步了哪些部门，讲这些部门构成一个哈希表m2，那么在目的数据中，不在哈希表m2中的部门就是我们需要删除的部门。</li>
</ol>
<h3 id="增量同步" class="relative group">增量同步 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%a2%9e%e9%87%8f%e5%90%8c%e6%ad%a5" aria-label="Anchor">#</a></span></h3>
<p>通过回调事件进行同步的方式可以理解为增量同步。</p>
<p>增量同步和全量同步的区别在于：前者是同步一个员工或者部门，后者是同步全量的员工和部门。</p>
<h4 id="部门的增量同步的基本流程" class="relative group">部门的增量同步的基本流程 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e9%83%a8%e9%97%a8%e7%9a%84%e5%a2%9e%e9%87%8f%e5%90%8c%e6%ad%a5%e7%9a%84%e5%9f%ba%e6%9c%ac%e6%b5%81%e7%a8%8b" aria-label="Anchor">#</a></span></h4>
<ol>
<li>准备数据：获取回调事件对应的源数据的部门信息A</li>
<li>判断映射关系汇中是否存在A的映射关系，令目的数据中的对应部门为a
<ol>
<li>若已存在并且目的数据中是否仍存在a，则判断父部门以及部门的基础信息是否相同，如果父部门不匹配，则先同步父部门（进入步骤1），然后再同步a</li>
<li>若不存在映射关系或者目的数据中已不存在a，则先同步父部门（进入步骤1），再根据部门名称匹配父部门下的子部门，若存在匹配的部门，则更新，否则创建。</li>
</ol>
</li>
</ol>
<p>需要特别说明同步部门负责人，因为存在循环创建问题：假设员工e存在于部门a，并且e是部门a的负责人，那么在创建部门a时需要先创建员工e，而创建员工e时因为需要同步员工的部门信息，因此又需要先创建部门a，所以进入了一个死循环。这个问题可以通过先创建部门，再同步部门负责人来解决。</p>
<h4 id="员工的增量同步的基本流程" class="relative group">员工的增量同步的基本流程 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%91%98%e5%b7%a5%e7%9a%84%e5%a2%9e%e9%87%8f%e5%90%8c%e6%ad%a5%e7%9a%84%e5%9f%ba%e6%9c%ac%e6%b5%81%e7%a8%8b" aria-label="Anchor">#</a></span></h4>
<ol>
<li>准备数据：获取回调事件对应的源数据的员工信息E</li>
<li>判断映射关系汇中是否存在E的映射关系，令目的数据中的对应员工为e
<ol>
<li>先同步员工的部门（流程见“部门的增量同步的基本流程”）</li>
<li>若存在员工的映射关系并且目的数据中仍存在e，则判断员工e的信息是否需要更新，需要则更新</li>
<li>若不存在员工的映射关系或者目的数据中已不存在e，则根据手机号来匹配，若能够匹配，则进行更新（进入步骤2），否则进行创建</li>
</ol>
</li>
</ol>
<h3 id="问题" class="relative group">问题 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e9%97%ae%e9%a2%98" aria-label="Anchor">#</a></span></h3>
<p>在增量同步员工和部门时，同步员工和部门的逻辑彼此嵌套，因此对员工和部门的同步逻辑进行了封装，实现了代码的解耦和复用。但是全量同步由于在一开始就获取了全量数据，不需要像增量同步那样一个数据一个数据的获取，因此<strong>全量同步没有复用增量同步的代码</strong>。</p>
<p>这造成了同一种逻辑的代码在全量同步和增量同步中分别写了一套，这无疑加大了维护的成本。</p>
<h2 id="第二版统一员工和部门的实现" class="relative group">第二版：统一员工和部门的实现 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e7%ac%ac%e4%ba%8c%e7%89%88%e7%bb%9f%e4%b8%80%e5%91%98%e5%b7%a5%e5%92%8c%e9%83%a8%e9%97%a8%e7%9a%84%e5%ae%9e%e7%8e%b0" aria-label="Anchor">#</a></span></h2>
<p>在第一版中，同步员工和部门在增量同步和全量同步中分别实现了一套，这个问题在第二版中得到了解决。</p>
<p>之所以分别实现是因为获取数据的方式不同：全量同步一次性获取了所有数据，而增量同步则是一个数据一个数据的获取。所以我们<strong>将业务逻辑和数据获取分开即可</strong>。</p>
<p>我们在第二版中构建了一个数据缓存池，每次获取数据都要从这个数据缓存池中读取，如果缓存池中不存在，则会请求接口。当然，更新或者删除数据也会同步缓存池。</p>
<p>在增量同步中，直接使用这个缓存池即可；而在全量同步时，需要先获取全量的数据来填充缓存池。这样两者的实现就得到了统一！</p>
<p>需要说明，这个缓存池是在内存中实现，在同步时创建，同步结束后释放。</p>
<h2 id="第三版抽象员工和部门的实现" class="relative group">第三版：抽象员工和部门的实现 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e7%ac%ac%e4%b8%89%e7%89%88%e6%8a%bd%e8%b1%a1%e5%91%98%e5%b7%a5%e5%92%8c%e9%83%a8%e9%97%a8%e7%9a%84%e5%ae%9e%e7%8e%b0" aria-label="Anchor">#</a></span></h2>
<p>随着业务的发展，我们从一开始的两个平台的通讯录同步，发展到了多个平台的通讯录同步，这些同步的核心逻辑是一样的，但是却没有复用。这会导致修改同步逻辑时往往需要对多个场景进行修改，很容易漏掉。</p>
<p>抽象的逻辑是这样的：</p>
<ol>
<li>将核心的不变的同步规则封装成方法，假设为F</li>
<li>将可变的同步逻辑通过接口I进行抽象</li>
<li>每个平台都去适配抽象出来的接口I</li>
<li>于是每次同步都去调用方法F即可</li>
</ol>
<p>这种抽象的好处是：</p>
<ol>
<li>核心的同步逻辑得到了复用</li>
<li>每个平台只需要关注自己特殊的地方，这种地方往往很少，因此能够节省大量的开发时间</li>
</ol>
<h3 id="举例部门同步实现" class="relative group">举例：部门同步实现 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e4%b8%be%e4%be%8b%e9%83%a8%e9%97%a8%e5%90%8c%e6%ad%a5%e5%ae%9e%e7%8e%b0" aria-label="Anchor">#</a></span></h3>
<p>以部门同步为例来看下如何实现。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">IDeptSync</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Pre 用于处理同步之前的逻辑，比如准备配置数据、对同步加锁等
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Pre</span><span class="p">()</span> <span class="p">(</span><span class="nx">after</span> <span class="kd">func</span><span class="p">(),</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// IsNeedSync 判断来源部门id是否需要同步
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">IsNeedSync</span><span class="p">(</span><span class="nx">sourceDeptID</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// GetSourceDept 获取来源数据的部门信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">GetSourceDept</span><span class="p">(</span><span class="nx">sourceDeptID</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="nx">ISourceDept</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">GetTargetDept</span><span class="p">(</span><span class="nx">targetDeptID</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="nx">ITargetDept</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// GetMatchedChild 在没有关联ID的情况下，通过父部门id和来源部门信息获取目的数据中匹配的部门
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">GetMatchedChild</span><span class="p">(</span><span class="nx">targetParentID</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">child</span> <span class="nx">ISourceDept</span><span class="p">)</span> <span class="p">(</span><span class="nx">ITargetDept</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// BindDeptMapping 绑定部门映射
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">BindDeptMapping</span><span class="p">(</span><span class="nx">targetID</span><span class="p">,</span> <span class="nx">sourceID</span> <span class="kd">interface</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// GetTargetDeptIDInMapping 获取已有的关联映射
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">GetTargetDeptIDInMapping</span><span class="p">(</span><span class="nx">sourceID</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="nx">targetID</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">exist</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// CreateDept 创建目的部门
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">CreateDept</span><span class="p">(</span><span class="nx">targetParentID</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">dept</span> <span class="nx">ISourceDept</span><span class="p">)</span> <span class="p">(</span><span class="nx">id</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// NeedUpdate 部门是否需要更新
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">NeedUpdate</span><span class="p">(</span><span class="nx">targetParentID</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">targetDept</span> <span class="nx">ITargetDept</span><span class="p">,</span> <span class="nx">sourceDept</span> <span class="nx">ISourceDept</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// UpdateDept 更新目的部门
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">UpdateDept</span><span class="p">(</span><span class="nx">targetDept</span> <span class="nx">ITargetDept</span><span class="p">,</span> <span class="nx">sourceDept</span> <span class="nx">ISourceDept</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// DeleteDept 删除目的部门
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">DeleteDept</span><span class="p">(</span><span class="nx">target</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">DeptSyncer</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">IDeptSync</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">DeptSyncer</span><span class="p">)</span> <span class="nf">SaveDept</span><span class="p">(</span><span class="nx">deptID</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="nx">id</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">after</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Pre</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nf">after</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">isNeedSync</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">IsNeedSync</span><span class="p">(</span><span class="nx">deptID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="p">!</span><span class="nx">isNeedSync</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">syncDept</span><span class="p">(</span><span class="nx">deptID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">DeptSyncer</span><span class="p">)</span> <span class="nf">syncDept</span><span class="p">(</span><span class="nx">deptID</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">sourceDept</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">GetSourceDept</span><span class="p">(</span><span class="nx">deptID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 递归同步父部门
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">targetParentID</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">syncDept</span><span class="p">(</span><span class="nx">sourceDept</span><span class="p">.</span><span class="nf">GetParentID</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 在已有的映射中获取目的部门id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">targetDeptID</span><span class="p">,</span> <span class="nx">exist</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">GetTargetDeptIDInMapping</span><span class="p">(</span><span class="nx">deptID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">exist</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 获取目的部门
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">targetDept</span><span class="p">,</span> <span class="nx">exist</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">GetTargetDept</span><span class="p">(</span><span class="nx">targetDeptID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 如果已存在目的部门，则直接更新
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">exist</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">needUpdate</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">NeedUpdate</span><span class="p">(</span><span class="nx">targetParentID</span><span class="p">,</span> <span class="nx">targetDept</span><span class="p">,</span> <span class="nx">sourceDept</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="p">!</span><span class="nx">needUpdate</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">targetDept</span><span class="p">.</span><span class="nf">GetID</span><span class="p">(),</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">UpdateDept</span><span class="p">(</span><span class="nx">targetDept</span><span class="p">,</span> <span class="nx">sourceDept</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">targetDept</span><span class="p">.</span><span class="nf">GetID</span><span class="p">(),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 根据父部门来获取匹配部门
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">targetDept</span><span class="p">,</span> <span class="nx">exist</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">GetMatchedChild</span><span class="p">(</span><span class="nx">targetParentID</span><span class="p">,</span> <span class="nx">sourceDept</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">exist</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nf">BindDeptMapping</span><span class="p">(</span><span class="nx">targetDept</span><span class="p">.</span><span class="nf">GetID</span><span class="p">(),</span> <span class="nx">sourceDept</span><span class="p">.</span><span class="nf">GetID</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="nx">needUpdate</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">NeedUpdate</span><span class="p">(</span><span class="nx">targetParentID</span><span class="p">,</span> <span class="nx">targetDept</span><span class="p">,</span> <span class="nx">sourceDept</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="p">!</span><span class="nx">needUpdate</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">UpdateDept</span><span class="p">(</span><span class="nx">targetDept</span><span class="p">,</span> <span class="nx">sourceDept</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">targetDept</span><span class="p">.</span><span class="nf">GetID</span><span class="p">(),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 已有部门中匹配不到，则直接创建
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">targetID</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">CreateDept</span><span class="p">(</span><span class="nx">targetParentID</span><span class="p">,</span> <span class="nx">sourceDept</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nf">BindDeptMapping</span><span class="p">(</span><span class="nx">targetID</span><span class="p">,</span> <span class="nx">sourceDept</span><span class="p">.</span><span class="nf">GetID</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">targetID</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>DeptSyncer</code>中的<code>SaveDept</code>方法中处理了部门同步的核心逻辑，这个方法中不涉及具体的平台信息，每个平台的都需要实现<code>IDeptSyncer</code>接口，这样就实现了多个平台使用同一套核心同步逻辑！</p>
<h3 id="延伸模版方法模式" class="relative group">延伸：模版方法模式 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%bb%b6%e4%bc%b8%e6%a8%a1%e7%89%88%e6%96%b9%e6%b3%95%e6%a8%a1%e5%bc%8f" aria-label="Anchor">#</a></span></h3>
<p>上述代码使用了<strong>模版方法模式</strong>，这个设计模式的好处是使用者（平台）无需关心底层的实现，只需实现少量的抽象接口即可；缺点是底层的实现无法修改，一旦修改就会影响所有使用者，即底层实现和使用者耦合了。</p>
<p>go代码中经常用做排序的sort包就是用的这一设计模式：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// sort.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Interface</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Len</span><span class="p">()</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Less</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">j</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Swap</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">j</span> <span class="kt">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>当我们对一组对象自定义排序时，实现这接口的三个方法即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">SortInt</span> <span class="p">[]</span><span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="nx">SortInt</span><span class="p">)</span> <span class="nf">Len</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="nx">SortInt</span><span class="p">)</span> <span class="nf">Less</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">j</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">s</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">&lt;</span> <span class="nx">s</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="nx">SortInt</span><span class="p">)</span> <span class="nf">Swap</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">j</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">s</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nx">s</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">s</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="其他问题" class="relative group">其他问题 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%85%b6%e4%bb%96%e9%97%ae%e9%a2%98" aria-label="Anchor">#</a></span></h2>
<h3 id="merkle-tree的应用" class="relative group">Merkle Tree的应用 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#merkle-tree%e7%9a%84%e5%ba%94%e7%94%a8" aria-label="Anchor">#</a></span></h3>
<p>由于定时同步的存在，导致访问其他平台的接口会十分频繁。而大部分平台为了保护自己的服务，往往会对接口进行限流，这时我们就需要减少对这些接口的访问。</p>
<p>解决方案是：在定时同步时，如果源数据没有做任何修改，则无需同步。</p>
<p>那么如何判断数据没有做修改呢？一种被动的方式是通过事件来判断，另外一种主动的方式是将数据编码为一个哈希值，每次同步前判断这个哈希值是否有改变，这个哈希的过程就是组件Merkle Tree的过程。</p>
<h4 id="对部门构建哈希树" class="relative group">对部门构建哈希树 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%af%b9%e9%83%a8%e9%97%a8%e6%9e%84%e5%bb%ba%e5%93%88%e5%b8%8c%e6%a0%91" aria-label="Anchor">#</a></span></h4>
<p>对部门树从下到上按层级递归构建：</p>
<ol>
<li>对同级部门排序</li>
<li>将每个部门的信息哈希得到一个值</li>
<li>连接相邻两个部门的哈希值之后再进行哈希得到哈希值</li>
<li>重复上个步骤，直到得到一个层级的部门哈希值</li>
<li>将层级部门的哈希值与父部门的哈希值连接之后进行哈希得到一个哈希值</li>
<li>重复以上步骤，直到得到整个部门树的哈希值</li>
</ol>
<h4 id="对员工构建哈希树" class="relative group">对员工构建哈希树 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%af%b9%e5%91%98%e5%b7%a5%e6%9e%84%e5%bb%ba%e5%93%88%e5%b8%8c%e6%a0%91" aria-label="Anchor">#</a></span></h4>
<ol>
<li>获取所有员工的信息，并排序</li>
<li>对每个员工的信息进行哈希</li>
<li>将哈希值两两连接，然后再进行哈希</li>
<li>重复上个步骤，直到得到最终的哈希值</li>
</ol>
<p>每次同步完后，都将部门和员工的默克尔哈希值保存，再下次同步时，判断哈希值是否相同，如果相同，则无需再同步。</p>
<h3 id="分布式同步" class="relative group">分布式同步 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%88%86%e5%b8%83%e5%bc%8f%e5%90%8c%e6%ad%a5" aria-label="Anchor">#</a></span></h3>
<h4 id="耗时分析" class="relative group">耗时分析 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e8%80%97%e6%97%b6%e5%88%86%e6%9e%90" aria-label="Anchor">#</a></span></h4>
<p>上述代码实现都是单线程同步的，假设一家企业有10万个员工和1万个部门，并且这些员工和部门都需要创建或者更新，那么一次同步所需时间可以大致估算为：</p>
<ol>
<li>每个员工/部门都需要查询一次，每次访问时间为20ms：11w*20ms = 36.6min</li>
<li>每个员工/部门都要创建或者更新，每次执行时间为200ms：11w*200ms=366min</li>
<li>两个平台，一个平台只读一次，另一个则要读+写，因此总时间：(366min+36.6*2min)≈7h</li>
</ol>
<p>估算时间是按照每个员工和部门都要调一次接口来计算的，实际上有些平台也确实是这样，而且有些平台的更新操作确实需要上百毫秒。</p>
<p>显然我们没办法忍受同步一家企业一次需要7个小时！</p>
<p>解决办法是使用MapReduce的方式对任务进行拆分、同步进行。需要明确的是“同步流程”不会变，也就是部门和员工之间的同步顺序不会变（否则会造成错误的同步），变的是对每步的执行进行了拆分。</p>
<h4 id="节点划分" class="relative group">节点划分 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e8%8a%82%e7%82%b9%e5%88%92%e5%88%86" aria-label="Anchor">#</a></span></h4>
<p>将节点分为1个主节点与多个子节点：</p>
<ol>
<li>主节点将花费时间的任务分发给子节点（实际上是主节点将任务放到队列中，由子节点主动消费）</li>
<li>子节点执行“子任务”并将任务结果传输给主节点</li>
<li>主任务整合任务结果，并执行对应的逻辑操作</li>
<li>重复上述步骤，直至整体同步结束</li>
</ol>
<p>主节点会耗费大量内存，因此在一个同步中的主节点，同时也是其他同步中的子节点。每次同步的角色划分可以通过etcd或zookeeper进行同步，这其实就是一个主节点竞选的过程，除了主节点，其他节点都是子节点。</p>
<h5 id="主节点竞选" class="relative group">主节点竞选 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e4%b8%bb%e8%8a%82%e7%82%b9%e7%ab%9e%e9%80%89" aria-label="Anchor">#</a></span></h5>
<p>理想情况下，主节点应该选择CPU和内存使用率较低的节点，但是这样做会将代码实现与运维实现耦合在一起，不是很好的选择，因此<strong>主节点竞选采用的是同步任务最少的节点</strong>。</p>
<h4 id="任务拆分" class="relative group">任务拆分 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e4%bb%bb%e5%8a%a1%e6%8b%86%e5%88%86" aria-label="Anchor">#</a></span></h4>
<ol>
<li>并行获取部门树：每次获取完部门信息，将子部门ID列表放到共享队列中，由各个节点消费共享队列，获取对应的部门信息 ，然后再将子部门ID列表放到共享队列中。重复这个步骤，直到获取完所有的部门信息。</li>
<li>并行获取员工信息：员工往往也是通过部门ID进行获取，因此逻辑同“并行获取部门树”。</li>
<li>更新部门和员工等流程同理。</li>
</ol>
<h4 id="完成通知" class="relative group">完成通知 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%ae%8c%e6%88%90%e9%80%9a%e7%9f%a5" aria-label="Anchor">#</a></span></h4>
<p>如何判断已经获取了所有的部门树呢？如何判断已经获取了所有员工的信息呢？也就是说主节点如何知道所有子节点已经完成了任务呢？</p>
<p>子节点可以在执行完任务后通知主节点，但是即使在一个主步骤中，子节点也会多次执行子任务，比如说会从任务队列中多次获取任务并执行，所以<strong>子节点只能判断自己当前是否还有在执行任务，但没办法判断是否不会有新任务了</strong>。</p>
<p>所以可行的办法是<strong>当主节点一段时间内没有接收到子节点上报的任务结果后，由主节点发起状态上报通知</strong>，如果所有子节点都汇报自身已无可执行任务，那么说明当前阶段的MapReduce完成。</p>
<h3 id="内存分析" class="relative group">内存分析 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%86%85%e5%ad%98%e5%88%86%e6%9e%90" aria-label="Anchor">#</a></span></h3>
<p>员工的字段要远多于部门的字段并且员工的数量也要多余部门的数量，所以我们简单分析下10w员工所需多少内存即可。</p>
<p>一个员工信息占用内存大概在500个字节，其中比较占用内存的是头像、邮箱这种字段。那么10w员工所需内存就是50MB，一次同步中需要两个平台，因此一次同步大概需要100MB内存，如果单节点的内存是8GB，那么一个节点（作为主节点）能够最多支持80个同步同时运行。</p>
<p>考虑到拥有10w员工的企业很少，大部分企业的员工都在1k以下，因此不用过多考虑内存问题。</p>
<h3 id="不同场景的限流" class="relative group">不同场景的限流 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e4%b8%8d%e5%90%8c%e5%9c%ba%e6%99%af%e7%9a%84%e9%99%90%e6%b5%81" aria-label="Anchor">#</a></span></h3>
<p>每个平台都有自己的访问频率限制，针对不同的限制也应采用不同的措施：</p>
<ol>
<li><strong>无脑访问</strong>：直到被限制访问后等待解除限制后再继续访问。这种策略适用于那种不太可能超过上限的访问限制，比如企业微信对每个第三方应用提供商每ip限制调用次数为4万次/分，这个上限在我们的系统中就不太可能会超过，万一在某个时间点超过了，那么1分钟之后也会解除限制，影响不大。</li>
<li><strong>令牌桶限流</strong>：通过redis构造一个全局的令牌桶限流。这种策略适用于很容易就超过上限的访问限制，比如钉钉要求每个企业的访问接口的频率不能超过20次/秒，在这种情况下，如果还继续使用“无脑访问”的策略，会导致大量的时间浪费，因此只能通过令牌桶进行限流。</li>
</ol>

      </div>
    </section>
    <footer class="pt-8 max-w-prose print:hidden">
      
  <div class="flex">
    
      
      
        
        <img
          class="!mb-0 !mt-0 me-4 h-24 w-24 rounded-full"
          width="96"
          height="96"
          alt="stong"
          src="/imgs/mine_hu9cc37546ab3d9fb1d864cca548ef6007_144068_192x192_fill_q75_box_center.jpg"
        />
      
    
    <div class="place-self-center">
      
        <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
          Author
        </div>
        <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
          stong
        </div>
      
      
        <div class="text-sm text-neutral-700 dark:text-neutral-400">进击的程序员</div>
      
      <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400"
          style="will-change:transform;"
          href="st5983@outlook.com"
          target="_blank"
          aria-label="Email"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>

  </span>

</a
        >
      
    
      
        <a
          class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400"
          style="will-change:transform;"
          href="https://stong1994.github.io/"
          target="_blank"
          aria-label="Link"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentColor" d="M172.5 131.1C228.1 75.51 320.5 75.51 376.1 131.1C426.1 181.1 433.5 260.8 392.4 318.3L391.3 319.9C381 334.2 361 337.6 346.7 327.3C332.3 317 328.9 297 339.2 282.7L340.3 281.1C363.2 249 359.6 205.1 331.7 177.2C300.3 145.8 249.2 145.8 217.7 177.2L105.5 289.5C73.99 320.1 73.99 372 105.5 403.5C133.3 431.4 177.3 435 209.3 412.1L210.9 410.1C225.3 400.7 245.3 404 255.5 418.4C265.8 432.8 262.5 452.8 248.1 463.1L246.5 464.2C188.1 505.3 110.2 498.7 60.21 448.8C3.741 392.3 3.741 300.7 60.21 244.3L172.5 131.1zM467.5 380C411 436.5 319.5 436.5 263 380C213 330 206.5 251.2 247.6 193.7L248.7 192.1C258.1 177.8 278.1 174.4 293.3 184.7C307.7 194.1 311.1 214.1 300.8 229.3L299.7 230.9C276.8 262.1 280.4 306.9 308.3 334.8C339.7 366.2 390.8 366.2 422.3 334.8L534.5 222.5C566 191 566 139.1 534.5 108.5C506.7 80.63 462.7 76.99 430.7 99.9L429.1 101C414.7 111.3 394.7 107.1 384.5 93.58C374.2 79.2 377.5 59.21 391.9 48.94L393.5 47.82C451 6.731 529.8 13.25 579.8 63.24C636.3 119.7 636.3 211.3 579.8 267.7L467.5 380z"/></svg>

  </span>

</a
        >
      
    
      
        <a
          class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400"
          style="will-change:transform;"
          href="https://github.com/stong1994"
          target="_blank"
          aria-label="Github"
          rel="me noopener noreferrer"
          >

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>

</a
        >
      
    
  </div>

</div>
    </div>
  </div>


      

      
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="group flex" href="/internet/design/fsm/">
              <span
                class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"
                ><span class="ltr:inline rtl:hidden">&larr;</span
                ><span class="ltr:hidden rtl:inline">&rarr;</span></span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >有限状态机小结</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2023-03-22 14:43:00 &#43;0800 CST">22 March 2023</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="group flex text-right" href="/internet/algorithm/12boll/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >12球问题</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2023-04-21 10:00:00 &#43;0800 CST">21 April 2023</time>
                  
                </span>
              </span>
              <span
                class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"
                ><span class="ltr:inline rtl:hidden">&rarr;</span
                ><span class="ltr:hidden rtl:inline">&larr;</span></span
              >
            </a>
          
        </span>
      </div>
    </div>
  


      
    </footer>
  </article>

        
          <div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12">
            <a
              href="#the-top"
              class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
              aria-label="Scroll to top"
              title="Scroll to top"
            >
              &uarr;
            </a>
          </div>
        
      </main><footer class="py-10 print:hidden">
  
  
  <div class="flex items-center justify-between">
    <div>
      
      
        <p class="text-sm text-neutral-500 dark:text-neutral-400">
            &copy;
            2023
            stong
        </p>
      
      
      
        <p class="text-xs text-neutral-500 dark:text-neutral-400">
          
          
          Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
            href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href="https://git.io/hugo-congo" target="_blank" rel="noopener noreferrer">Congo</a>
        </p>
      
    </div>
    
    
      <div
        class="me-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
      >
        <button id="appearance-switcher-0" type="button" aria-label="appearance switcher">
          <div
            class="flex h-12 w-12 items-center justify-center dark:hidden"
            title="Switch to dark appearance"
          >
            

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


          </div>
          <div
            class="hidden h-12 w-12 items-center justify-center dark:flex"
            title="Switch to light appearance"
          >
            

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


          </div>
        </button>
      </div>
    
  </div>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 z-50 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url=""
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

    </div>
  </body>
</html>
