<!DOCTYPE html>
<html lang="zh">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="zh">
    

    
    <meta name="description" content="背景 已有的支付服务经常出现支付失败、支付状态不准确等问题，且由于历史原因使用的.net开发，维护上有一定困难，因此我们决定重新做一个统一支付系统。
需求 统一支付系统需要满足以下几点需求：
 对接微信、支付宝中的多种支付方式 处理微信、支付宝的回调结果，并通过事件分发平台通知业务方。 开发环境和测试环境要支持1分钱开关，打开开关后，任何支付都是1分钱 支持退款 需要对账功能  架构设计   红色流程为订单的预支付流程。
  黄色流程为用户支付流程，为用户与第三方服务商交互。
  绿色流程为第三方服务商回调流程
  预支付流程  用户在客户端点击商品选择支付 业务系统处理订单逻辑，并调用通用支付系统发起下单请求 通用支付系统调用对应的第三方服务商，获取支付二维码地址或者唤起客户端支付地址，并返回给业务系统，业务系统将其返回给前端 前端接收到地址后，将其转换为二维码或者调换到微信/支付宝客户端支付页面  回调流程   第三方服务商在收到用户支付或者拒绝后，会发送支付结果到回调网关
  回调网关对数据进行解密、校验并将解析出来的数据发往事件分发平台
  由于通用支付系统订阅了该事件，因此事件分发平台会将该事件发送给通用支付系统
  通用支付系统处理支付结果，并将最终的支付状态通过事件分发平台发送给业务子系统
  时序图-以微信的Native支付为例 注意事项 支付和退款分离 由于是统一支付系统，需要兼容各服务商的支付和退款，因此，为了高扩展性，将支付和退款作为两种订单处理，每种都有自己的订单状态
统一支付接口参数 支付宝和微信的支付接口支持非常多的参数，这其中大部分是用不到的，因此在做接口设计时，没必要将这些参数放进去，保持接口的简洁。
统一支付/退款状态 支付宝和微信的支付/退款状态并不同。
 微信有：未支付、已关闭、已撤销、支付失败、支付成功、转入退款、等待扣款 支付宝有：订单创建、交易成功、交易超时或者已全额退款、交易结束  作为统一支付系统，我们需要有自己的一套交易状态来兼容第三方服务商的交易状态。
支付状态：
 交易创建：即未收到任何回调时 交易成功：存在真实的资金流动 交易失败：由于服务商内部服务原因导致交易失败，比如由银行返回的支付失败。 交易关闭：没有真实的资金流动，如交易被撤销，用户付款超时导致交易取消  退款状态：
 退款订单创建 退款关闭 退款成功 退款失败  统一单位 微信支付的最小单位为分，而支付宝的单位为元，支持小数。统一支付接口设计上以分为单位，不支持小数。">
    <meta name="keywords" content="">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="统一支付系统"/>
<meta name="twitter:description" content="背景 已有的支付服务经常出现支付失败、支付状态不准确等问题，且由于历史原因使用的.net开发，维护上有一定困难，因此我们决定重新做一个统一支付系统。
需求 统一支付系统需要满足以下几点需求：
 对接微信、支付宝中的多种支付方式 处理微信、支付宝的回调结果，并通过事件分发平台通知业务方。 开发环境和测试环境要支持1分钱开关，打开开关后，任何支付都是1分钱 支持退款 需要对账功能  架构设计   红色流程为订单的预支付流程。
  黄色流程为用户支付流程，为用户与第三方服务商交互。
  绿色流程为第三方服务商回调流程
  预支付流程  用户在客户端点击商品选择支付 业务系统处理订单逻辑，并调用通用支付系统发起下单请求 通用支付系统调用对应的第三方服务商，获取支付二维码地址或者唤起客户端支付地址，并返回给业务系统，业务系统将其返回给前端 前端接收到地址后，将其转换为二维码或者调换到微信/支付宝客户端支付页面  回调流程   第三方服务商在收到用户支付或者拒绝后，会发送支付结果到回调网关
  回调网关对数据进行解密、校验并将解析出来的数据发往事件分发平台
  由于通用支付系统订阅了该事件，因此事件分发平台会将该事件发送给通用支付系统
  通用支付系统处理支付结果，并将最终的支付状态通过事件分发平台发送给业务子系统
  时序图-以微信的Native支付为例 注意事项 支付和退款分离 由于是统一支付系统，需要兼容各服务商的支付和退款，因此，为了高扩展性，将支付和退款作为两种订单处理，每种都有自己的订单状态
统一支付接口参数 支付宝和微信的支付接口支持非常多的参数，这其中大部分是用不到的，因此在做接口设计时，没必要将这些参数放进去，保持接口的简洁。
统一支付/退款状态 支付宝和微信的支付/退款状态并不同。
 微信有：未支付、已关闭、已撤销、支付失败、支付成功、转入退款、等待扣款 支付宝有：订单创建、交易成功、交易超时或者已全额退款、交易结束  作为统一支付系统，我们需要有自己的一套交易状态来兼容第三方服务商的交易状态。
支付状态：
 交易创建：即未收到任何回调时 交易成功：存在真实的资金流动 交易失败：由于服务商内部服务原因导致交易失败，比如由银行返回的支付失败。 交易关闭：没有真实的资金流动，如交易被撤销，用户付款超时导致交易取消  退款状态：
 退款订单创建 退款关闭 退款成功 退款失败  统一单位 微信支付的最小单位为分，而支付宝的单位为元，支持小数。统一支付接口设计上以分为单位，不支持小数。"/>

    <meta property="og:title" content="统一支付系统" />
<meta property="og:description" content="背景 已有的支付服务经常出现支付失败、支付状态不准确等问题，且由于历史原因使用的.net开发，维护上有一定困难，因此我们决定重新做一个统一支付系统。
需求 统一支付系统需要满足以下几点需求：
 对接微信、支付宝中的多种支付方式 处理微信、支付宝的回调结果，并通过事件分发平台通知业务方。 开发环境和测试环境要支持1分钱开关，打开开关后，任何支付都是1分钱 支持退款 需要对账功能  架构设计   红色流程为订单的预支付流程。
  黄色流程为用户支付流程，为用户与第三方服务商交互。
  绿色流程为第三方服务商回调流程
  预支付流程  用户在客户端点击商品选择支付 业务系统处理订单逻辑，并调用通用支付系统发起下单请求 通用支付系统调用对应的第三方服务商，获取支付二维码地址或者唤起客户端支付地址，并返回给业务系统，业务系统将其返回给前端 前端接收到地址后，将其转换为二维码或者调换到微信/支付宝客户端支付页面  回调流程   第三方服务商在收到用户支付或者拒绝后，会发送支付结果到回调网关
  回调网关对数据进行解密、校验并将解析出来的数据发往事件分发平台
  由于通用支付系统订阅了该事件，因此事件分发平台会将该事件发送给通用支付系统
  通用支付系统处理支付结果，并将最终的支付状态通过事件分发平台发送给业务子系统
  时序图-以微信的Native支付为例 注意事项 支付和退款分离 由于是统一支付系统，需要兼容各服务商的支付和退款，因此，为了高扩展性，将支付和退款作为两种订单处理，每种都有自己的订单状态
统一支付接口参数 支付宝和微信的支付接口支持非常多的参数，这其中大部分是用不到的，因此在做接口设计时，没必要将这些参数放进去，保持接口的简洁。
统一支付/退款状态 支付宝和微信的支付/退款状态并不同。
 微信有：未支付、已关闭、已撤销、支付失败、支付成功、转入退款、等待扣款 支付宝有：订单创建、交易成功、交易超时或者已全额退款、交易结束  作为统一支付系统，我们需要有自己的一套交易状态来兼容第三方服务商的交易状态。
支付状态：
 交易创建：即未收到任何回调时 交易成功：存在真实的资金流动 交易失败：由于服务商内部服务原因导致交易失败，比如由银行返回的支付失败。 交易关闭：没有真实的资金流动，如交易被撤销，用户付款超时导致交易取消  退款状态：
 退款订单创建 退款关闭 退款成功 退款失败  统一单位 微信支付的最小单位为分，而支付宝的单位为元，支持小数。统一支付接口设计上以分为单位，不支持小数。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://stong1994.github.io/internet/design/basepay/" /><meta property="article:section" content="internet" />
<meta property="article:published_time" content="2021-09-30T14:31:11+08:00" />
<meta property="article:modified_time" content="2021-09-30T14:31:11+08:00" />



    <title>
  统一支付系统 · 北人
</title>

    
      <link rel="canonical" href="https://stong1994.github.io/internet/design/basepay/">
    

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel="stylesheet">
    <link rel="preload" href="/fonts/forkawesome-webfont.woff2?v=1.1.7" as="font" type="font/woff2" crossorigin>

    
      
      
      <link rel="stylesheet" href="/css/coder.min.6d489c9de70b01718344ed2ac642db21c4bb3c62941cb95963c2b67c66c07fdc.css" integrity="sha256-bUicnecLAXGDRO0qxkLbIcS7PGKUHLlZY8K2fGbAf9w=" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="/css/coder-dark.min.126ad3988d46bdae6217a11105b53c9662bca05f39d42d3c0fb366919d334620.css" integrity="sha256-EmrTmI1Gva5iF6ERBbU8lmK8oF851C08D7NmkZ0zRiA=" crossorigin="anonymous" media="screen" />
      
    

    

    

    <link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

    
      <script defer src="https://twemoji.maxcdn.com/v/13.0.1/twemoji.min.js"
        integrity="sha384-5f4X0lBluNY/Ib4VhGx0Pf6iDCF99VGXJIyYy7dDLY5QlEd7Ap0hICSSZA1XYbc4" crossorigin="anonymous"></script>
    

    <meta name="generator" content="Hugo 0.89.4" />
  </head>

  
  
    
  
  <body class="colorscheme-auto"
        onload=" twemoji.parse(document.body); "
  >
    
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      北人
    </a>
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="/internet/">互联网</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/book/">读书</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/life/">生活</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/about/">关于</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


      <div class="content">
        
    <div id="toc" class="well col-md-4 col-sm-6">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#背景">背景</a></li>
    <li><a href="#需求">需求</a></li>
    <li><a href="#架构设计">架构设计</a>
      <ul>
        <li><a href="#预支付流程"><strong>预支付流程</strong></a></li>
        <li><a href="#回调流程"><strong>回调流程</strong></a></li>
        <li><a href="#时序图-以微信的native支付为例"><strong>时序图-以微信的Native支付为例</strong></a></li>
      </ul>
    </li>
    <li><a href="#注意事项">注意事项</a>
      <ul>
        <li><a href="#支付和退款分离">支付和退款分离</a></li>
        <li><a href="#统一支付接口参数">统一支付接口参数</a></li>
        <li><a href="#统一支付退款状态">统一支付/退款状态</a></li>
        <li><a href="#统一单位">统一单位</a></li>
        <li><a href="#幂等性">幂等性</a></li>
      </ul>
    </li>
    <li><a href="#公众号配置">公众号配置</a>
      <ul>
        <li><a href="#配置项">配置项</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
  <section class="container page">
  <article>
    <header>
      <h1>统一支付系统</h1>
    </header>

    <h2 id="背景">背景</h2>
<p>已有的支付服务经常出现支付失败、支付状态不准确等问题，且由于历史原因使用的.net开发，维护上有一定困难，因此我们决定重新做一个统一支付系统。</p>
<h2 id="需求">需求</h2>
<p>统一支付系统需要满足以下几点需求：</p>
<ol>
<li>对接微信、支付宝中的多种支付方式</li>
<li>处理微信、支付宝的回调结果，并通过事件分发平台通知业务方。</li>
<li>开发环境和测试环境要支持1分钱开关，打开开关后，任何支付都是1分钱</li>
<li>支持退款</li>
<li>需要对账功能</li>
</ol>
<h2 id="架构设计">架构设计</h2>
<p><img src="https://raw.githubusercontent.com/stong1994/images/master/picgo/20210930150553.png" alt=""></p>
<ul>
<li>
<p><strong>红色流程</strong>为订单的<strong>预支付流程。</strong></p>
</li>
<li>
<p><strong>黄色流程</strong>为用户支付流程，为<strong>用户与第三方服务商交互</strong>。</p>
</li>
<li>
<p><strong>绿色流程</strong>为第三方服务商<strong>回调流程</strong></p>
</li>
</ul>
<h3 id="预支付流程"><strong>预支付流程</strong></h3>
<ol>
<li>用户在客户端点击商品选择支付</li>
<li><strong>业务系统</strong>处理订单逻辑，并调用<strong>通用支付系统</strong>发起下单请求</li>
<li><strong>通用支付系统</strong>调用对应的<strong>第三方服务商</strong>，获取支付二维码地址或者唤起客户端支付地址，并返回给<strong>业务系统</strong>，业务系统将其返回给<strong>前端</strong></li>
<li><strong>前端</strong>接收到地址后，将其转换为二维码或者调换到微信/支付宝客户端支付页面</li>
</ol>
<h3 id="回调流程"><strong>回调流程</strong></h3>
<ol>
<li>
<p><strong>第三方服务商</strong>在收到用户支付或者拒绝后，会发送支付结果到<strong>回调网关</strong></p>
</li>
<li>
<p><strong>回调网关</strong>对数据进行解密、校验并将解析出来的数据发往<strong>事件分发平台</strong></p>
</li>
<li>
<p>由于通用支付系统订阅了该事件，因此<strong>事件分发平台</strong>会将该事件发送给<strong>通用支付系统</strong></p>
</li>
<li>
<p><strong>通用支付系统</strong>处理支付结果，并将最终的支付状态通过<strong>事件分发平台</strong>发送给<strong>业务子系统</strong></p>
</li>
</ol>
<h3 id="时序图-以微信的native支付为例"><strong>时序图-以微信的Native支付为例</strong></h3>
<p><img src="https://raw.githubusercontent.com/stong1994/images/master/picgo/20210930151933.jpg" alt=""></p>
<h2 id="注意事项">注意事项</h2>
<h3 id="支付和退款分离">支付和退款分离</h3>
<p>由于是统一支付系统，需要兼容各服务商的支付和退款，因此，为了高扩展性，将支付和退款作为两种订单处理，每种都有自己的订单状态</p>
<h3 id="统一支付接口参数">统一支付接口参数</h3>
<p>支付宝和微信的支付接口支持非常多的参数，这其中大部分是用不到的，因此在做接口设计时，没必要将这些参数放进去，保持接口的简洁。</p>
<h3 id="统一支付退款状态">统一支付/退款状态</h3>
<p>支付宝和微信的支付/退款状态并不同。</p>
<ul>
<li>微信有：未支付、已关闭、已撤销、支付失败、支付成功、转入退款、等待扣款</li>
<li>支付宝有：订单创建、交易成功、交易超时或者已全额退款、交易结束</li>
</ul>
<p>作为统一支付系统，我们需要有自己的一套交易状态来兼容第三方服务商的交易状态。</p>
<p><strong>支付状态</strong>：</p>
<ul>
<li>交易创建：即未收到任何回调时</li>
<li>交易成功：<strong>存在真实的资金流动</strong></li>
<li>交易失败：由于<strong>服务商内部服务原因导致交易失败</strong>，比如由银行返回的支付失败。</li>
<li>交易关闭：<strong>没有真实的资金流动</strong>，如交易被撤销，用户付款超时导致交易取消</li>
</ul>
<p><strong>退款状态：</strong></p>
<ul>
<li>退款订单创建</li>
<li>退款关闭</li>
<li>退款成功</li>
<li>退款失败</li>
</ul>
<h3 id="统一单位">统一单位</h3>
<p>微信支付的最小单位为分，而支付宝的单位为元，支持小数。统一支付接口设计上以分为单位，不支持小数。</p>
<h3 id="幂等性">幂等性</h3>
<p>为了避免由于网络原因导致的超时重试，需要保证重复请求的数据保持一致。方案为：</p>
<ol>
<li>调用方需要携带幂等参数，该参数为uuid等唯一值</li>
<li>统一支付系统接收到请求后，对该uuid值进行分布式全局锁处理，并且将响应结果已uuid为key存入redis中。如果使用请求中的幂等参数在获取锁时，发现该锁已存在，则等待锁结束，从redis中获取其结果，并返回。</li>
</ol>
<h2 id="公众号配置">公众号配置</h2>
<p>用于JSAPI支付，<a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_3">官方文档</a></p>
<h3 id="配置项">配置项</h3>
<h4 id="关联appid与商户">关联appid与商户</h4>
<p><a href="https://kf.qq.com/faq/1801116VJfua1801113QVNVz.html">https://kf.qq.com/faq/1801116VJfua1801113QVNVz.html</a></p>
<h4 id="支付目录">支付目录</h4>
<p>支付目录需要在商户系统配置，且只需要配置一次</p>
<h4 id="授权域名">授权域名</h4>
<p>配置授权域名，并将所得证书放在对应域名下的根目录</p>
<h4 id="js安全域名">JS安全域名</h4>
<p>同上</p>
<h4 id="设置ip白名单">设置ip白名单</h4>
<p>授权域名和JS安全域名设置都需要设置相关的ip白名单，而腾讯需要对证书进行访问，以证明我们对域名的拥有。</p>
<ol>
<li>获取<a href="https://mp.weixin.qq.com/debug?token=491549116&amp;lang=zh_CN">accesstoken</a></li>
<li>获取<a href="https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_the_WeChat_server_IP_address.html">微信服务器地址</a>(注意，是用第二个接口)</li>
</ol>

  </article>
</section>

  

      </div>

      
  <footer class="footer">
    <section class="container">
      
        <p>夭寿不贰，修身以俟</p>
      
      
        ©
        
          2021 -
        
        2022
        
      
      
         · 
         <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
      
      
    </section>
  </footer>


    </main>

    
      
        
        <script src="/js/dark-mode.min.aee9c8a464eb7b3534c7110f7c5e169e7039e2fd92710e0626d451d6725af137.js"></script>
      
    

    

    

    

    

    

    

    
  </body>

</html>
