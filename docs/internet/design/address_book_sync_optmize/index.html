






<!doctype html>
<html
  lang="en"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="dark"
  data-auto-appearance="true"
><head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="rgb(255,255,255)" />
  
  <title>通讯录同步-同步速度优化 &middot; 主页</title>
    <meta name="title" content="通讯录同步-同步速度优化 &middot; 主页" />
  
  
  
  
  
  <script
    type="text/javascript"
    src="/js/appearance.min.74ad8406faea02f3e186ba5126249aaeed9073629e04b05037b903396b188724.js"
    integrity="sha256-dK2EBvrqAvPhhrpRJiSaru2Qc2KeBLBQN7kDOWsYhyQ="
  ></script>
  
  
  
  
  
  
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="/css/main.bundle.min.9602fe0216290b9ff0322c1fd14e88ab9fc0a13741f4de563f67831708d72bb2.css"
    integrity="sha256-lgL&#43;AhYpC5/wMiwf0U6Iq5/AoTdB9N5WP2eDFwjXK7I="
  />
  
    
    
    
  
  
  
    
    
  
  
    
    
  
  
  
    
    <script
      defer
      type="text/javascript"
      id="script-bundle"
      src="/js/main.bundle.min.bb487ad6073790cb02c354ee8c5f8822c42c5513e10bf7a86bbe8f82118cd1fc.js"
      integrity="sha256-u0h61gc3kMsCw1TujF&#43;IIsQsVRPhC/eoa76PghGM0fw="
      data-copy="Copy"
      data-copied="Copied"
    ></script>
  
  
  <meta
    name="description"
    content="
      通讯录同步-同步速度优化
    "
  />
  
  
  
  <link rel="canonical" href="/internet/design/address_book_sync_optmize/" />
  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  
  <meta property="og:url" content="/internet/design/address_book_sync_optmize/">
  <meta property="og:site_name" content="主页">
  <meta property="og:title" content="通讯录同步-同步速度优化">
  <meta property="og:description" content="通讯录同步-同步速度优化">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="internet">
    <meta property="article:published_time" content="2024-08-09T01:43:00+08:00">
    <meta property="article:modified_time" content="2024-08-09T01:43:00+08:00">
    <meta property="article:tag" content="项目">
    <meta property="article:tag" content="通讯录">
    <meta property="article:tag" content="优化">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="通讯录同步-同步速度优化">
  <meta name="twitter:description" content="通讯录同步-同步速度优化">

  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "",
    "name": "通讯录同步-同步速度优化",
    "headline": "通讯录同步-同步速度优化",
    "description": "通讯录同步-同步速度优化",
    
    "inLanguage": "en",
    "url" : "\/internet\/design\/address_book_sync_optmize\/",
    "author" : {
      "@type": "Person",
      "name": "stong"
    },
    "copyrightYear": "2024",
    "dateCreated": "2024-08-09T01:43:00\u002b08:00",
    "datePublished": "2024-08-09T01:43:00\u002b08:00",
    
    "dateModified": "2024-08-09T01:43:00\u002b08:00",
    
    "keywords": ["项目","通讯录","优化"],
    
    "mainEntityOfPage": "true",
    "wordCount": "3714"
  }
  </script>


  
  <meta name="author" content="stong" />
  
    
      <link href="st5983@outlook.com" rel="me" />
    
      <link href="https://stong1994.github.io/" rel="me" />
    
      <link href="https://github.com/stong1994" rel="me" />
    
  
  
  






  
  
  
  
  
  




  
  
</head>
<body
    class="m-auto flex h-screen max-w-7xl flex-col bg-neutral px-6 text-lg leading-7 text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral"
  >
    <div id="the-top" class="absolute flex self-center">
      <a
        class="-translate-y-8 rounded-b-lg bg-primary-200 px-3 py-1 text-sm focus:translate-y-0 dark:bg-neutral-600"
        href="#main-content"
        ><span class="pe-2 font-bold text-primary-600 dark:text-primary-400">&darr;</span
        >Skip to main content</a
      >
    </div>
    
    
      <header class="py-6 font-semibold text-neutral-900 print:hidden sm:py-10 dark:text-neutral">
  <nav class="flex items-start justify-between sm:items-center">
    
    <div class="z-40 flex flex-row items-center">
      
  <a
    class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
    rel="me"
    href="/"
    >主页</a
  >

    </div>
    
      
      <label id="menu-button" for="menu-controller" class="block sm:hidden">
        <input type="checkbox" id="menu-controller" class="hidden" />
        <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
          <span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>
</span>
        </div>
        <div
          id="menu-wrapper"
          class="invisible fixed inset-0 z-30 m-auto h-full w-full cursor-default overflow-auto bg-neutral-100/50 opacity-0 backdrop-blur-sm transition-opacity dark:bg-neutral-900/50"
        >
          <ul
            class="mx-auto flex w-full max-w-7xl list-none flex-col overflow-visible px-6 py-6 text-end sm:px-14 sm:py-10 sm:pt-10 md:px-24 lg:px-32"
          >
            <li class="mb-1">
              <span class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"
                ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>
</span></span
              >
            </li>
            
              
                
                <li class="group mb-1">
                  
                    <a
                      href="/internet/"
                      title=""
                      onclick="close_menu()"
                      
                      ><span
                          class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                          >计算机与互联网</span
                        >
                      </a
                    >
                  
                </li>
              
                
                <li class="group mb-1">
                  
                    <a
                      href="/cloudnative/"
                      title=""
                      onclick="close_menu()"
                      
                      ><span
                          class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                          >云原生</span
                        >
                      </a
                    >
                  
                </li>
              
                
                <li class="group mb-1">
                  
                    <a
                      href="/web3/"
                      title=""
                      onclick="close_menu()"
                      
                      ><span
                          class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                          >区块链&amp;web3</span
                        >
                      </a
                    >
                  
                </li>
              
                
                <li class="group mb-1">
                  
                    <a
                      href="/book/"
                      title=""
                      onclick="close_menu()"
                      
                      ><span
                          class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                          >读书笔记</span
                        >
                      </a
                    >
                  
                </li>
              
                
                <li class="group mb-1">
                  
                    <a
                      href="/other/"
                      title=""
                      onclick="close_menu()"
                      
                      ><span
                          class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                          >杂谈</span
                        >
                      </a
                    >
                  
                </li>
              
                
                <li class="group mb-1">
                  
                    <a
                      href="/slip_paper/"
                      title=""
                      onclick="close_menu()"
                      
                      ><span
                          class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                          >小碎片</span
                        >
                      </a
                    >
                  
                </li>
              
                
                <li class="group mb-1">
                  
                    <a
                      href="/mental_model/"
                      title=""
                      onclick="close_menu()"
                      
                      ><span
                          class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                          >心智模型</span
                        >
                      </a
                    >
                  
                </li>
              
                
                <li class="group mb-1">
                  
                    <a
                      href="/about/"
                      title=""
                      onclick="close_menu()"
                      
                      ><span
                          class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                          >关于</span
                        >
                      </a
                    >
                  
                </li>
              
                
                <li class="group mb-1">
                  
                    <a
                      href="https://github.com/stong1994/"
                      title=""
                      onclick="close_menu()"
                      target="_blank"
                      >
                        <span
                          class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"
                        ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a
                    >
                  
                </li>
              
                
                <li class="group mb-1">
                  
                    
                    
                      <button
                        id="search-button-1"
                        title="Search (/)"
                      >
                        
                          <span
                            class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"
                          ><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></span><span
                            class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                            ></span
                          >
                        
                      </button>
                    
                  
                </li>
              
              
            
          </ul>
        </div>
      </label>
      
      <ul class="hidden list-none flex-row text-end sm:flex">
        
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="/internet/"
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >计算机与互联网</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="/cloudnative/"
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >云原生</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="/web3/"
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >区块链&amp;web3</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="/book/"
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >读书笔记</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="/other/"
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >杂谈</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="/slip_paper/"
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >小碎片</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="/mental_model/"
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >心智模型</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="/about/"
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >关于</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                <a
                  href="https://github.com/stong1994/"
                  title=""
                  target="_blank"
                  >
                    <span
                      class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"
                    ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0">
              
                
                
                  <button
                    id="search-button-2"
                    title="Search (/)"
                  >
                    
                      <span
                        class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"
                      ><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></span><span
                        class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                        ></span
                      >
                    
                  </button>
                
              
            </li>
          
          

        
      </ul>
    
  </nav>
</header>

    
    <div class="relative flex grow flex-col">
      <main id="main-content" class="grow">
        
  <article>
    <header class="max-w-prose">
      
        <ol class="text-sm text-neutral-500 print:hidden dark:text-neutral-400">
  
  
    
  
    
  
  <li class="hidden inline">
    <a
      class="dark:underline-neutral-600 decoration-neutral-300 hover:underline"
      href="/"
      >记录个人的成长记录</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class=" inline">
    <a
      class="dark:underline-neutral-600 decoration-neutral-300 hover:underline"
      href="/internet/"
      >internet</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="hidden inline">
    <a
      class="dark:underline-neutral-600 decoration-neutral-300 hover:underline"
      href="/internet/design/address_book_sync_optmize/"
      >通讯录同步-同步速度优化</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

</ol>


      
      <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        通讯录同步-同步速度优化
      </h1>
      
        <div class="mb-12 mt-8 text-base text-neutral-500 print:hidden dark:text-neutral-400">
          





  
  



  

  
  
    
  

  

  
    
  

  
    
  

  
    
  


  <div class="flex flex-row flex-wrap items-center">
    
    
      <time datetime="2024-08-09 01:43:00 &#43;0800 CST">9 August 2024</time><span class="px-2 text-primary-500">&middot;</span><span>3714 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">8 mins</span><span class="px-2 text-primary-500">&middot;</span>


  
  

<span class="mb-[2px]">
  <a
    href="https://github.com/stong1994/cristo/content/internet/design/%e9%80%9a%e8%ae%af%e5%bd%95%e5%90%8c%e6%ad%a5%e6%9c%8d%e5%8a%a1-%e5%90%8c%e6%ad%a5%e9%80%9f%e5%ba%a6%e4%bc%98%e5%8c%96.md"
    class="text-lg hover:text-primary-500"
    rel="noopener noreferrer"
    target="_blank"
    title="Edit content"
    ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M490.3 40.4C512.2 62.27 512.2 97.73 490.3 119.6L460.3 149.7L362.3 51.72L392.4 21.66C414.3-.2135 449.7-.2135 471.6 21.66L490.3 40.4zM172.4 241.7L339.7 74.34L437.7 172.3L270.3 339.6C264.2 345.8 256.7 350.4 248.4 353.2L159.6 382.8C150.1 385.6 141.5 383.4 135 376.1C128.6 370.5 126.4 361 129.2 352.4L158.8 263.6C161.6 255.3 166.2 247.8 172.4 241.7V241.7zM192 63.1C209.7 63.1 224 78.33 224 95.1C224 113.7 209.7 127.1 192 127.1H96C78.33 127.1 64 142.3 64 159.1V416C64 433.7 78.33 448 96 448H352C369.7 448 384 433.7 384 416V319.1C384 302.3 398.3 287.1 416 287.1C433.7 287.1 448 302.3 448 319.1V416C448 469 405 512 352 512H96C42.98 512 0 469 0 416V159.1C0 106.1 42.98 63.1 96 63.1H192z"/></svg>
</span></a
  >
</span>
    

    
    
  </div>

  
  
    <div class="my-1 flex flex-wrap text-xs leading-relaxed text-neutral-500 dark:text-neutral-400">
      
        
      
        
          
            <a
              href="/tags/%E9%A1%B9%E7%9B%AE/"
              class="mx-1 my-1 rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400"
              >项目</a
            >
          
            <a
              href="/tags/%E9%80%9A%E8%AE%AF%E5%BD%95/"
              class="mx-1 my-1 rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400"
              >通讯录</a
            >
          
            <a
              href="/tags/%E4%BC%98%E5%8C%96/"
              class="mx-1 my-1 rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400"
              >优化</a
            >
          
        
      
    </div>
  


        </div>
      
      
    </header>
    <section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row">
      
        <div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8">
          <div class="toc pe-5 print:hidden lg:sticky lg:top-10">
            <details open class="-ms-5 mt-0 overflow-hidden rounded-lg ps-5">
  <summary
    class="block cursor-pointer bg-neutral-100 py-1 ps-5 text-lg font-semibold text-neutral-800 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden"
  >
    Table of Contents
  </summary>
  <div class="border-s border-dotted border-neutral-300 py-2 ps-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#定义问题是什么">定义：问题是什么</a></li>
    <li><a href="#目标要解决哪些问题">目标：要解决哪些问题</a></li>
    <li><a href="#问题一单个企业同步时间过长">问题一：单个企业同步时间过长</a>
      <ul>
        <li><a href="#串行改并行">串行改并行</a>
          <ul>
            <li><a href="#搞清依赖关系">搞清依赖关系</a></li>
            <li><a href="#依赖循环">依赖循环</a></li>
            <li><a href="#解决循环依赖">解决循环依赖</a>
              <ul>
                <li><a href="#拆解">拆解</a></li>
                <li><a href="#合并">合并</a></li>
              </ul>
            </li>
            <li><a href="#构造图">构造图</a></li>
            <li><a href="#识别环">识别环</a></li>
            <li><a href="#异步同步">异步同步</a></li>
          </ul>
        </li>
        <li><a href="#避免重复同步">避免重复同步</a>
          <ul>
            <li><a href="#哈希">哈希</a></li>
            <li><a href="#默克尔树">默克尔树</a>
              <ul>
                <li><a href="#默克尔树构造">默克尔树构造</a>
                  <ul>
                    <li><a href="#默克尔哈希值的计算">默克尔哈希值的计算</a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#信息变更检测的必要性">信息变更检测的必要性</a></li>
          </ul>
        </li>
        <li><a href="#服务商接口访问频率限制">服务商接口访问频率限制</a></li>
      </ul>
    </li>
    <li><a href="#问题二-多企业串行同步">问题二: 多企业串行同步</a>
      <ul>
        <li><a href="#数据量预估">数据量预估</a></li>
        <li><a href="#钉钉">钉钉</a></li>
        <li><a href="#企微">企微</a></li>
      </ul>
    </li>
    <li><a href="#相关阅读">相关阅读</a></li>
  </ul>
</nav>
  </div>
</details>

          </div>
        </div>
      
      <div class="min-h-0 min-w-0 max-w-prose grow">
        <h1 id="定义问题是什么" class="relative group">定义：问题是什么 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%ae%9a%e4%b9%89%e9%97%ae%e9%a2%98%e6%98%af%e4%bb%80%e4%b9%88" aria-label="Anchor">#</a></span></h1><ol>
<li>企微、钉钉、飞书等平台为了保护自己的服务，都会有对应的限流策略。因此在第一版的的定时同步中，企业是一家一家同步的。这导致客户设置的中午12点同步，很可能在下午3点才开始同步。</li>
<li>在一家企业的同步流程中存在依赖关系，比如要先同步部门再同步员工。所以在第一版的定时同步中，部门和员工的同步是串行的，这导致员工较多的企业同步的时间较长。</li>
</ol>
<h1 id="目标要解决哪些问题" class="relative group">目标：要解决哪些问题 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e7%9b%ae%e6%a0%87%e8%a6%81%e8%a7%a3%e5%86%b3%e5%93%aa%e4%ba%9b%e9%97%ae%e9%a2%98" aria-label="Anchor">#</a></span></h1><ol>
<li>首先要解决单个企业同步时间过长的问题。因为
<ol>
<li>这个影响测试同学的工作效率, 比如一次测试需要10分钟，那么一个小时也测不了几个场景。</li>
<li>直接影响客户的使用体验。比如客户点击了同步，却要等半个小时才能看到结果。</li>
</ol>
</li>
<li>在解决上个问题的基础上，提供解决多企业串行同步的问题。</li>
</ol>
<h1 id="问题一单个企业同步时间过长" class="relative group">问题一：单个企业同步时间过长 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e9%97%ae%e9%a2%98%e4%b8%80%e5%8d%95%e4%b8%aa%e4%bc%81%e4%b8%9a%e5%90%8c%e6%ad%a5%e6%97%b6%e9%97%b4%e8%bf%87%e9%95%bf" aria-label="Anchor">#</a></span></h1><h2 id="串行改并行" class="relative group">串行改并行 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e4%b8%b2%e8%a1%8c%e6%94%b9%e5%b9%b6%e8%a1%8c" aria-label="Anchor">#</a></span></h2><p>解决【单个企业同步时间过长】的问题，首先考虑通过并发的形式去同步部门和员工。这就需要<strong>搞清楚同步内在的依赖关系</strong>。</p>
<h3 id="搞清依赖关系" class="relative group">搞清依赖关系 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e6%90%9e%e6%b8%85%e4%be%9d%e8%b5%96%e5%85%b3%e7%b3%bb" aria-label="Anchor">#</a></span></h3><ol>
<li>同步员工之前需要先同步其所属部门（所属部门可以有多个）</li>
<li>同步员工之前需要先同步其直属leader</li>
<li>同步部门之前需要先同步父部门</li>
<li>同步部门之前需要先同步部门负责人（部门负责人可以有多个）</li>
</ol>
<p>






  
  
<figure><img src="https://raw.githubusercontent.com/stong1994/images/master/picgo/202408221556070.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<h3 id="依赖循环" class="relative group">依赖循环 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e4%be%9d%e8%b5%96%e5%be%aa%e7%8e%af" aria-label="Anchor">#</a></span></h3><p>理想情况下，存在依赖关系的同步应该是一个有向无环图，但是实际上它是有环的：</p>
<ol>
<li>
<p>部门同步需要先同步部分负责人，员工同步需要先同步所属部门。这里部门负责人和所属部门的同步就产生了一个环。</p>
<p>






  
  
<figure><img src="https://raw.githubusercontent.com/stong1994/images/master/picgo/202408221557397.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
</li>
<li>
<p>同步员工之前需要同步其直属leader，这个过程也可以产生一个环：A-&gt;B, B-&gt;C, C-&gt;A。</p>
<p>






  
  
<figure><img src="https://raw.githubusercontent.com/stong1994/images/master/picgo/202408221558031.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
</li>
</ol>
<h3 id="解决循环依赖" class="relative group">解决循环依赖 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e8%a7%a3%e5%86%b3%e5%be%aa%e7%8e%af%e4%be%9d%e8%b5%96" aria-label="Anchor">#</a></span></h3><p>现在我们的同步关系是一个有向图，这个图是存在环的。环的存在会导致程序进入<strong>死循环</strong>: 同步部门时，要先去同步部门负责人，同步部门负责人时，要先去同步部门。</p>
<p>所以我们必须要<strong>去环</strong>。</p>
<h4 id="拆解" class="relative group">拆解 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e6%8b%86%e8%a7%a3" aria-label="Anchor">#</a></span></h4><p>






  
  
<figure><img src="https://raw.githubusercontent.com/stong1994/images/master/picgo/202408221559129.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>我们可以对循环依赖的部分进行拆解——先将部分信息剥离，先同步主要信息，最后同步剥离的信息：</p>
<ol>
<li>对于依赖循环1，我们可以在同步部门时先不同步部门负责人，同步完部门和员工后再同步部门负责人。</li>
<li>对于依赖循环2，我们可以在同步员工时先不同步直属leader，同步完员工和部门后再同步直属leader。</li>
</ol>
<p>当然，在同步时也要检查是否存在循环依赖，如果不存在，也就不需要进行拆分。</p>
<h4 id="合并" class="relative group">合并 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%90%88%e5%b9%b6" aria-label="Anchor">#</a></span></h4><p>






  
  
<figure><img src="https://raw.githubusercontent.com/stong1994/images/master/picgo/202408221559855.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>我们也可以将循环依赖的部分合并成一个节点，通过一个特殊的方法去处理这个节点。</p>
<p>处理逻辑：</p>
<ol>
<li>通过递归找到”最小环“（合并的节点中可能存在多个环，并且存在嵌套关系，通过递归可以找到最小环）</li>
<li>判断造成环的原因：
<ul>
<li>如果是部门与部门负责人之间的环，则同步部门时先不同步部门负责人，同步完”最小环“后再同步部门的负责人字段</li>
<li>如果是员工直属leader之间的环，则随便找到”最小环“中的一个员工，先不同步其直属leader，同步完”最小环“后再同步这个员工的直属leader字段</li>
</ul>
</li>
<li>递归以上两个过程，直到没有环为止。</li>
</ol>
<p>相比较与<a href="#%e6%8b%86%e8%a7%a3">拆解</a>，合并的逻辑更加复杂，但是合并的逻辑更符合<strong>人的自然操作</strong>——换句话说就是更符合<strong>领域规则</strong>，这样做是有好处的, 比如说采用<a href="#%e6%8b%86%e8%a7%a3">拆解</a>的做法:</p>
<ol>
<li>同步员工/部门后的需要记录同步日志以展示给客户。 正常情况下，同步完一个员工就记一个同步状态、员工标识，但是在同步剥离的信息时，就要判断这个员工/部门是否已经记录在册，如果已存在，就不要再记录</li>
<li>同步员工/部门后的需要更新同步进度，这个会在客户的页面展示一个进度条。进度的展示是根据当前同步的员工/部门数除以员工加上部门的总数得到的。这意味着在同步“剥离”的信息时，不应该更新这个进度，因为这个员工/部门已经在之前算进去了。所以用户的进度条会在后边“走的更慢”。</li>
</ol>
<p>采用<a href="#%e5%90%88%e5%b9%b6">合并</a>的做法，可以避免上述问题，因为我们是通过一个特殊的方法去处理这个造成循环的节点，在这个节点内部，我们知道哪些员工/部门需要记日志，并且进度计算也不会产生问题。</p>
<h3 id="构造图" class="relative group">构造图 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e6%9e%84%e9%80%a0%e5%9b%be" aria-label="Anchor">#</a></span></h3><h3 id="识别环" class="relative group">识别环 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e8%af%86%e5%88%ab%e7%8e%af" aria-label="Anchor">#</a></span></h3><p>可以通过<a href="https://zh.wikipedia.org/wiki/%E7%A7%91%E8%90%A8%E6%8B%89%E6%9C%B1%E7%AE%97%E6%B3%95" target="_blank" rel="noreferrer">kosaraju算法</a>或者<code>Tarjan</code>算法来识别环（强连通分量）。</p>
<h3 id="异步同步" class="relative group">异步同步 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%bc%82%e6%ad%a5%e5%90%8c%e6%ad%a5" aria-label="Anchor">#</a></span></h3><ol>
<li>找到图中入度为0的节点（就叫它起始节点吧）</li>
<li>同步起始节点。如果这个节点是一个环，就将这个环的中节点信息以<strong>降级</strong>的方式同步（比如先不同步部门负责人身份&amp;先不同步直属leader）。</li>
<li>同步完起始节点后，找到起始节点的下游节点。</li>
<li>判断下游节点所依赖的上游节点是否都已同步。一个节点可能依赖多个父级节点，如员工依赖部门节点以及直属leader节点。</li>
<li>如果父级节点都已同步，直接同步该节点。</li>
<li>如果父级节点存在未同步的情况，将该节点放入【待同步池】中。</li>
<li>每同步完一个节点，判断【待同步池】中是否有依赖该节点的下游节点，如果有并且该下游节点所有依赖的父级节点已同步，同步该下游节点</li>
<li>同步完节点后，找到其下游节点，并执行步骤5.</li>
</ol>
<h2 id="避免重复同步" class="relative group">避免重复同步 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e9%81%bf%e5%85%8d%e9%87%8d%e5%a4%8d%e5%90%8c%e6%ad%a5" aria-label="Anchor">#</a></span></h2><p>在同步一家企业的部门和员工时，理想状态下，如果一个部门和员工已经做过同步并且没做更改，就不需要再次同步。</p>
<p>也就是说，我们需要一个手段来检测员工/部门是否有变更。</p>
<h3 id="哈希" class="relative group">哈希 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%93%88%e5%b8%8c" aria-label="Anchor">#</a></span></h3><p>我们可以把员工/部门的信息做成一个哈希，保存在数据库中。每次同步前，比较最新的信息的哈希值与之前的哈希值是否相同，相同的则说明信息未变更，因此无需同步。</p>
<p>这样做的缺点就是需要存储的哈希值很多：一家一万人的企业，就需要存储一万个哈希值(考虑到部门数应远小于员工数，因此在计数时可忽略部门的影响)。</p>
<h3 id="默克尔树" class="relative group">默克尔树 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e9%bb%98%e5%85%8b%e5%b0%94%e6%a0%91" aria-label="Anchor">#</a></span></h3><p>






  
  
<figure><img src="https://raw.githubusercontent.com/stong1994/images/master/picgo/202408222356223.png" alt="" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>默克尔树的特点就是通过不断合并哈希值，从而减少存储的哈希值的数量。使用默克尔树，我们存储的哈希值数量不再是员工数+部门数，而只是部门数。考虑到部门数应远小于员工数，这种方式能够节省不少存储空间。</p>
<p>采用默克尔树的另一个优点就是可以节省大量的对比时间——如果部门的哈希值相同，那么其子部门以及子部门下的员工的信息一定相同。因此对于实际场景（企业的员工、部门信息不会频繁变更），可节省大量的同步时间。</p>
<h4 id="默克尔树构造" class="relative group">默克尔树构造 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e9%bb%98%e5%85%8b%e5%b0%94%e6%a0%91%e6%9e%84%e9%80%a0" aria-label="Anchor">#</a></span></h4><p>我们的默克尔树有如下特点：</p>
<ol>
<li>默克尔树的节点实际上与部门树的节点一一对应。</li>
<li>根节点是公司（如果设置了同步范围，那就是多个部门+员工）</li>
<li>子节点是部门和员工。</li>
<li>如果子节点是部门，那么这个部门可以是叶子节点，也可以是非叶子节点。</li>
<li>如果子节点是员工，那么员工是叶子节点。</li>
</ol>
<p>默克尔树要求子节点是有序的，因为顺序会影响哈希值的计算。而子节点顺序只影响父节点的哈希值，因此通过ID进行排序即可(员工和部门一定存在ID)。</p>
<h5 id="默克尔哈希值的计算" class="relative group">默克尔哈希值的计算 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e9%bb%98%e5%85%8b%e5%b0%94%e5%93%88%e5%b8%8c%e5%80%bc%e7%9a%84%e8%ae%a1%e7%ae%97" aria-label="Anchor">#</a></span></h5><ol>
<li>递归部门树</li>
<li>对一个部门节点，获取部门信息的哈希值、员工信息的哈希值以及子部门的默克尔哈希值</li>
<li>通过ID对员工和部门排序，然后将其对应的哈希值按顺序拼接成一个字符串，然后对这个字符串取哈希，这个哈希就是父部门的默克尔哈希值。</li>
</ol>
<p>员工/部门信息的哈希值的计算方式是：将员工/部门信息的字段按顺序拼接成一个字符串，然后对这个字符串取哈希。</p>
<h3 id="信息变更检测的必要性" class="relative group">信息变更检测的必要性 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e4%bf%a1%e6%81%af%e5%8f%98%e6%9b%b4%e6%a3%80%e6%b5%8b%e7%9a%84%e5%bf%85%e8%a6%81%e6%80%a7" aria-label="Anchor">#</a></span></h3><p>在之前的版本，我们没有检测信息是否变动，仅仅是通过映射关系找到同步双方的两个实体（部门或员工），然后比对每个字段是否相同。</p>
<p>现在我们是通过计算哈希值来判断信息是否变更。也就是说我们将查找实体并对比字段的过程改成了计算哈希并对比的过程。这个优化并不能带来多少性能提升，但是它代表了一种业务规则：如果已同步并且信息未变更，那么就无需再次同步。</p>
<h2 id="服务商接口访问频率限制" class="relative group">服务商接口访问频率限制 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e6%9c%8d%e5%8a%a1%e5%95%86%e6%8e%a5%e5%8f%a3%e8%ae%bf%e9%97%ae%e9%a2%91%e7%8e%87%e9%99%90%e5%88%b6" aria-label="Anchor">#</a></span></h2><p>服务商对接口的访问频率有限制，超过这个限制会被禁止在短时间内再次访问，因此我们需要控制访问的频率。</p>
<p>所以我们需要实现一个<strong>限流器</strong>，这个限流器的实现包括：</p>
<ol>
<li>通过装饰器模式对服务商接口进行封装。</li>
<li>通过令牌桶算法控制访问频率。</li>
<li>如果拿不到令牌，就等待，直到拿到令牌为止。</li>
<li>通过redis来实现分布式的令牌桶算法。</li>
</ol>
<p>即使我们能够保证访问服务商的接口不会超过频率限制，但是过多的并发还是会导致同步之间的互相阻塞，这一点在定时同步时多企业并行同步时会很明显。</p>
<h1 id="问题二-多企业串行同步" class="relative group">问题二: 多企业串行同步 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e9%97%ae%e9%a2%98%e4%ba%8c-%e5%a4%9a%e4%bc%81%e4%b8%9a%e4%b8%b2%e8%a1%8c%e5%90%8c%e6%ad%a5" aria-label="Anchor">#</a></span></h1><p>解决完问题一后，多企业已经可以并行同步了。需要注意的点是如何控制同步企业的并发数量。这与每个服务商的频率限制策略有关。</p>
<h2 id="数据量预估" class="relative group">数据量预估 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e6%95%b0%e6%8d%ae%e9%87%8f%e9%a2%84%e4%bc%b0" aria-label="Anchor">#</a></span></h2><p>我们保守估计，平均每家企业有6000次服务商接口请求, 这些请求会在1分钟内跑完，也就是说一家企业平均每分钟会访问1000次。</p>
<h2 id="钉钉" class="relative group">钉钉 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e9%92%89%e9%92%89" aria-label="Anchor">#</a></span></h2><p><a href="https://open.dingtalk.com/document/isvapp/invocation-frequency-limit-1" target="_blank" rel="noreferrer">文档来源</a></p>
<p>钉钉的频率限制策略是分两个维度：</p>
<ul>
<li>每个IP调用所有接口总量，最高20秒10000次。</li>
<li>每个应用，对每个授权企业，调用每个接口，最高频率40次/秒。</li>
</ul>
<p>那么：</p>
<ul>
<li>对于授权企业的维度，每分钟最多访问2400次。这对于我们的预估是足够的。</li>
<li>对于IP的维度，假设我们只有一个出口IP，一分钟最多30000次，而我们一家企业需要一分钟1000次，因此可以最多有30家企业并发同步。</li>
</ul>
<h2 id="企微" class="relative group">企微 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e4%bc%81%e5%be%ae" aria-label="Anchor">#</a></span></h2><p><a href="https://developer.work.weixin.qq.com/document/path/90454" target="_blank" rel="noreferrer">文档来源</a></p>
<p>企微也是对应的限制策略：</p>
<ul>
<li>每企业调用单个cgi/api不可超过1万次/分，15万次/小时</li>
<li>第三方应用提供商每ip调用单个cgi/api不可超过4万次/分，120万次/小时</li>
</ul>
<p>那么：</p>
<ul>
<li>从企业的维度来看，虽然要比钉钉的限制更严格，但是由于我们的总量会控制在1万次以内，因此也不会超过企微的限制。</li>
<li>从第三方应用提供商的维度来看，我们按照1小时的120万次来算，每分钟最多有2万次访问，平均一家企业每分钟1000次，那么最多并发同步的企业数量是20家。</li>
</ul>
<p>因此，根据不同的服务商，设置不同的企业并发数量即可。</p>
<h1 id="相关阅读" class="relative group">相关阅读 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e7%9b%b8%e5%85%b3%e9%98%85%e8%af%bb" aria-label="Anchor">#</a></span></h1><ul>
<li><a href="https://juejin.cn/post/6850418116167417869#heading-7" target="_blank" rel="noreferrer">图解：有向环、拓扑排序与Kosaraju算法</a></li>
<li><a href="https://dev.to/abaron10/finding-strongly-connected-components-scc-in-directed-graphs-kosaraju-sharir-vs-tarjans-algorithm-in-go-42pa" target="_blank" rel="noreferrer">Finding strongly connected components (SCC) in directed graphs: Kosaraju-Sharir vs Tarjan’s algorithm in Go</a></li>
</ul>

      </div>
    </section>
    <footer class="max-w-prose pt-8 print:hidden">
      
  <div class="flex">
    
    
    
      
      
        
        








  
    <picture
      class="!mb-0 !mt-0 me-4 w-24 h-auto rounded-full"
      
    >
      
      
      
      
      <img
        width="1080"
        height="1434"
        class="!mb-0 !mt-0 me-4 w-24 h-auto rounded-full"
        alt="stong"
        loading="lazy" decoding="async"
        
          src="/imgs/mine_hu9cc37546ab3d9fb1d864cca548ef6007_144068_660x0_resize_q75_box.jpg"
          srcset="/imgs/mine_hu9cc37546ab3d9fb1d864cca548ef6007_144068_330x0_resize_q75_box.jpg 330w,/imgs/mine_hu9cc37546ab3d9fb1d864cca548ef6007_144068_660x0_resize_q75_box.jpg 660w
          
            ,/imgs/mine_hu9cc37546ab3d9fb1d864cca548ef6007_144068_1024x0_resize_q75_box.jpg 1024w
          
          
            ,/imgs/mine.jpg 1080w
          "
          sizes="100vw"
        
      />
    </picture>
  


      
    
    <div class="place-self-center">
      
        <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
          Author
        </div>
        <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
          stong
        </div>
      
      
        <div class="text-sm text-neutral-700 dark:text-neutral-400">进击的程序员</div>
      
      <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400"
          style="will-change:transform;"
          href="st5983@outlook.com"
          target="_blank"
          aria-label="Email"
          rel="me noopener noreferrer"
          ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>
</span></a
        >
      
    
      
        <a
          class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400"
          style="will-change:transform;"
          href="https://stong1994.github.io/"
          target="_blank"
          aria-label="Link"
          rel="me noopener noreferrer"
          ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentColor" d="M172.5 131.1C228.1 75.51 320.5 75.51 376.1 131.1C426.1 181.1 433.5 260.8 392.4 318.3L391.3 319.9C381 334.2 361 337.6 346.7 327.3C332.3 317 328.9 297 339.2 282.7L340.3 281.1C363.2 249 359.6 205.1 331.7 177.2C300.3 145.8 249.2 145.8 217.7 177.2L105.5 289.5C73.99 320.1 73.99 372 105.5 403.5C133.3 431.4 177.3 435 209.3 412.1L210.9 410.1C225.3 400.7 245.3 404 255.5 418.4C265.8 432.8 262.5 452.8 248.1 463.1L246.5 464.2C188.1 505.3 110.2 498.7 60.21 448.8C3.741 392.3 3.741 300.7 60.21 244.3L172.5 131.1zM467.5 380C411 436.5 319.5 436.5 263 380C213 330 206.5 251.2 247.6 193.7L248.7 192.1C258.1 177.8 278.1 174.4 293.3 184.7C307.7 194.1 311.1 214.1 300.8 229.3L299.7 230.9C276.8 262.1 280.4 306.9 308.3 334.8C339.7 366.2 390.8 366.2 422.3 334.8L534.5 222.5C566 191 566 139.1 534.5 108.5C506.7 80.63 462.7 76.99 430.7 99.9L429.1 101C414.7 111.3 394.7 107.1 384.5 93.58C374.2 79.2 377.5 59.21 391.9 48.94L393.5 47.82C451 6.731 529.8 13.25 579.8 63.24C636.3 119.7 636.3 211.3 579.8 267.7L467.5 380z"/></svg>
</span></a
        >
      
    
      
        <a
          class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400"
          style="will-change:transform;"
          href="https://github.com/stong1994"
          target="_blank"
          aria-label="Github"
          rel="me noopener noreferrer"
          ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></a
        >
      
    
  </div>

</div>
    </div>
  </div>


      

      
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="group flex" href="/internet/event-driven/saga/">
              <span
                class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"
                ><span class="ltr:inline rtl:hidden">&larr;</span
                ><span class="ltr:hidden rtl:inline">&rarr;</span></span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >事件驱动系列—saga</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2024-07-22 03:00:00 &#43;0800 CST">22 July 2024</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
        </span>
      </div>
    </div>
  


      
    </footer>
  </article>

        
          <div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12">
            <a
              href="#the-top"
              class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
              aria-label="Scroll to top"
              title="Scroll to top"
            >
              &uarr;
            </a>
          </div>
        
      </main><footer class="py-10 print:hidden">
  
  
  <div class="flex items-center justify-between">
    <div>
      
      
        <p class="text-sm text-neutral-500 dark:text-neutral-400">
            &copy;
            2024
            stong
        </p>
      
      
      
        <p class="text-xs text-neutral-500 dark:text-neutral-400">
          
          
          Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
            href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href="https://github.com/jpanther/congo" target="_blank" rel="noopener noreferrer">Congo</a>
        </p>
      
    </div>
    <div class="flex flex-row items-center">
      
      
      
      
        <div
          class="me-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        >
          <button id="appearance-switcher-0" type="button" aria-label="appearance switcher">
            <div
              class="flex h-12 w-12 items-center justify-center dark:hidden"
              title="Switch to dark appearance"
            >
              <span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>
</span>
            </div>
            <div
              class="hidden h-12 w-12 items-center justify-center dark:flex"
              title="Switch to light appearance"
            >
              <span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>
</span>
            </div>
          </button>
        </div>
      
    </div>
  </div>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 z-50 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm sm:p-6 md:p-[10vh] lg:p-[12vh] dark:bg-neutral-900/50"
  data-url="/"
>
  <div
    id="search-modal"
    class="top-20 mx-auto flex min-h-0 w-full max-w-3xl flex-col rounded-md border border-neutral-200 bg-neutral shadow-lg dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex flex-none items-center justify-between px-2">
      <form class="flex min-w-0 flex-auto items-center">
        <div class="flex h-8 w-8 items-center justify-center text-neutral-400">
          <span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span>
        </div>
        <input
          type="search"
          id="search-query"
          class="mx-1 flex h-12 flex-auto appearance-none bg-transparent focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex h-8 w-8 items-center justify-center text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        <span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>
</span>
      </button>
    </header>
    <section class="flex-auto overflow-auto px-2">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

    </div>
  </body>
</html>
